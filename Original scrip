import random
import math
import pandas as pd
from collections import defaultdict

# --- 1. CONFIGURACI√ìN GLOBAL ---
SHOPPING_CART = defaultdict(float)

def reset_shopping_cart():
    SHOPPING_CART.clear()

def add_to_cart(nombre, cantidad):
    SHOPPING_CART[nombre] += cantidad

# --- 2. BASE DE DATOS (ESTANDARIZADA) ---
DB = {
    "Lacteos": [
        ("Leche Semidesnatada", 250, "ml"), # Vaso est√°ndar
        ("Yogur Natural", 125, "g"),        # Unidad est√°ndar
        ("Queso Fresco Batido", 100, "g"),
        ("K√©fir", 200, "ml")
    ],
    "Proteina_Snack": [ 
        ("Pechuga de Pavo (>90% carne)", 50, "g"),
        ("Jam√≥n Serrano (Sin grasa)", 40, "g"),
        ("Lomo Embuchado", 40, "g"),
        ("At√∫n al Natural (Lata peque√±a)", 52, "g"), 
        ("Huevo Cocido (Tama√±o M/L)", 1, "ud")
    ],
    "Proteina_Plato": [ 
        # Base 100g para facilitar el redondeo posterior
        ("Pechuga de Pollo", 100, "g"), 
        ("Filete de Ternera Magra", 100, "g"),
        ("Lomo de Cerdo Fresco", 100, "g"),
        ("Merluza/Pescado Blanco", 100, "g"),
        ("Salm√≥n/Pescado Azul", 100, "g"),
        ("Sepia/Calamar/Pot√≥n", 100, "g")
    ],
    "Carbo_Desayuno_Dulce": [ 
        ("Copos de Avena", 30, "g"),
        ("Muesli sin az√∫car a√±adido", 30, "g")
    ],
    "Carbo_Desayuno_Salado": [ 
        ("Pan 100% Integral", 40, "g"),
        ("Pan de Masa Madre", 40, "g"),
        ("Tortitas de Ma√≠z", 30, "g")
    ],
    "Carbo_Guarnicion": [ 
        ("Arroz Integral", 40, "g"), 
        ("Pasta Integral", 40, "g"),
        ("Patata Cocida/Asada", 150, "g"),
        ("Legumbres (Garbanzos/Lentejas)", 100, "g"), 
        ("Quinoa", 40, "g")
    ],
    "Verduras": [ 
        ("Mezcla de Lechugas", 150, "g"),
        ("Calabac√≠n", 200, "g"),
        ("Espinacas", 200, "g"),
        ("Jud√≠as Verdes", 150, "g"),
        ("Parrillada de Verduras", 200, "g"),
        ("Br√≥coli/Coliflor", 200, "g")
    ],
    "Frutas": [ 
        ("Manzana", 150, "g"), ("Pl√°tano", 80, "g"),
        ("Mandarinas", 150, "g"), ("Kiwi", 100, "g"), ("Pera", 150, "g"),
        ("Fresas", 200, "g"), ("Mel√≥n/Sand√≠a", 200, "g")
    ],
    "Grasas_Salado": [ # Para cocinar o tostadas
        ("Aceite de Oliva Virgen Extra", 10, "g"),
        ("Aguacate", 50, "g"),
        ("Aceitunas", 40, "g")
    ],
    "Grasas_Acompanamiento": [
        ("Aguacate (Troceado)", 50, "g"),
        ("Aceitunas", 50, "g"),
        ("Queso Curado", 30, "g"),
        ("Nueces", 20, "g")
    ],
    "Grasas_Dulce": [ 
        ("Nueces", 15, "g"), 
        ("Almendras al natural", 15, "g"),
        ("Semillas de Calabaza", 15, "g"),
        ("Semillas de Ch√≠a", 10, "g"),
        ("Semillas de Lino", 10, "g"),
        ("Crema de Cacahuete 100%", 15, "g")
    ]
}

# --- 3. C√ÅLCULO CIENT√çFICO ---

def calcular_requerimientos():
    print("\n" + "="*70)
    print("   PLANIFICADOR NUTRICIONAL PROFESIONAL v12.0")
    print("   (L√≥gica Realista: Pesos exactos y Gu√≠a Completa)")
    print("="*70)
    
    # --- INPUTS CON LENGUAJE NATURAL ---
    try:
        print("\n--- 1. Datos Personales ---")
        peso = float(input("   > Introduce tu peso actual en kg (ej. 75.5): "))
        talla = float(input("   > Introduce tu altura en cm (ej. 178): "))
        edad = int(input("   > Introduce tu edad en a√±os: "))
        sexo = input("   > Sexo biol√≥gico (Hombre 'H' / Mujer 'M'): ").strip().upper()
    except:
        print("   [!] Error en datos. Usando perfil est√°ndar: Hombre, 75kg, 24 a√±os.")
        peso, talla, edad, sexo = 75, 178, 24, 'H'

    # Harris-Benedict
    if sexo == 'H':
        tmb = 66.5 + (13.75 * peso) + (5 * talla) - (6.78 * edad)
    else:
        tmb = 665 + (9.56 * peso) + (1.85 * talla) - (4.68 * edad)

    print("\n--- 2. Nivel de Actividad Diaria ---")
    print("   [1] Sedentario (Trabajo de oficina, poco o nada de ejercicio)")
    print("   [2] Ligero (Caminar, ejercicio suave 1-3 d√≠as/semana)")
    print("   [3] Moderado (Deporte medio 3-5 d√≠as/semana)")
    print("   [4] Intenso (Deporte fuerte 6-7 d√≠as/semana)")
    opcion_act = input("   > Selecciona una opci√≥n (1-4): ")
    act_map = {'1': 1.2, '2': 1.375, '3': 1.55, '4': 1.725}
    act = act_map.get(opcion_act, 1.55)
    
    kcal_mantenimiento = tmb * act

    print("\n--- 3. Frecuencia de Comidas ---")
    print("   [3] Tres comidas: Desayuno, Almuerzo y Cena")
    print("   [4] Cuatro comidas: A√±adiendo Merienda")
    print("   [5] Cinco comidas: A√±adiendo Media Ma√±ana y Merienda")
    try:
        n_comidas_input = int(input("   > Selecciona una opci√≥n (3, 4, 5): "))
        if n_comidas_input not in [3, 4, 5]: n_comidas = 4
        else: n_comidas = n_comidas_input
    except:
        n_comidas = 4

    print("\n--- 4. Objetivo Nutricional ---")
    print("   [A] Perder Grasa (D√©ficit Cal√≥rico)")
    print("   [B] Mantenimiento (Normocal√≥rica)")
    print("   [C] Ganar Masa Muscular (Super√°vit Cal√≥rico)")
    obj_raw = input("   > Selecciona tu objetivo (A/B/C): ").strip().upper()
    
    ajuste = 0
    if obj_raw == 'A':
        print("\n   ¬øQu√© ritmo prefieres?")
        print("   [1] Conservador (-10%): Lento pero muy sostenible")
        print("   [2] Moderado (-15%): El est√°ndar recomendado")
        print("   [3] Agresivo (-20%): M√°ximo saludable")
        intensidad = input("   > Selecciona intensidad (1-3): ")
        ajuste = -0.20 if intensidad == '3' else (-0.15 if intensidad == '2' else -0.10)
    elif obj_raw == 'C':
        print("\n   ¬øQu√© ritmo prefieres?")
        print("   [1] Ganancia limpia (+10%): Minimiza grasa")
        print("   [2] Volumen est√°ndar (+15%)")
        print("   [3] Volumen alto (+20%)")
        intensidad = input("   > Selecciona intensidad (1-3): ")
        ajuste = 0.20 if intensidad == '3' else (0.15 if intensidad == '2' else 0.10)
    
    kcal_objetivo = kcal_mantenimiento * (1 + ajuste)
    
    # --- C√ÅLCULO DE MACROS ---
    # Prote√≠na FIJA a 1.6 g/kg (Evidencia cient√≠fica √≥ptima para naturales)
    g_prot = peso * 1.6
    
    # Grasa: M√≠nimo 1.0 g/kg para salud hormonal
    g_grasa = peso * 1.0 
    
    kcal_ocupadas = (g_prot * 4) + (g_grasa * 9)
    kcal_restantes = kcal_objetivo - kcal_ocupadas
    
    # M√≠nimo de seguridad para hidratos (evitar dietas cetog√©nicas involuntarias)
    if kcal_restantes < 300: 
        kcal_restantes = 300
        kcal_objetivo = kcal_ocupadas + 300
        
    g_hc = kcal_restantes / 4

    # Convertir a "Bloques" abstractos para el algoritmo de reparto
    bloques = {
        "HC": g_hc / 30,      # aprox 30g HC por bloque
        "PROT": g_prot / 25,  # aprox 25g P por bloque
        "GRASA": g_grasa / 10 # aprox 10g G por bloque
    }
    
    return int(kcal_objetivo), bloques, n_comidas, g_prot

# --- 4. GESTI√ìN DE CANTIDADES (REDONDEO INTELIGENTE) ---

def redondear_cantidad(valor, paso):
    """Redondea 'valor' al m√∫ltiplo m√°s cercano de 'paso'."""
    if valor <= 0: return 0
    return int(round(valor / paso) * paso)

def get_ingrediente_ajustado(categoria, raciones, paso_redondeo=5):
    if raciones <= 0: return "", 0
    
    nombre, base, unidad = random.choice(DB[categoria])
    cantidad_cruda = base * raciones
    
    # L√≥gica de Redondeo seg√∫n tipo de unidad
    if unidad == "ud":
        total = math.ceil(cantidad_cruda)
    else:
        # Aqu√≠ aplicamos el redondeo solicitado (ej. 50g para carnes)
        total = redondear_cantidad(cantidad_cruda, paso_redondeo)
        # Evitar cantidades rid√≠culas (ej. 0g o 15g de carne)
        if categoria == "Proteina_Plato" and total < 100: total = 100
    
    key = f"{nombre} ({unidad})"
    add_to_cart(key, total)
    
    return f"{nombre} ({total}{unidad})", 0

# --- 5. EL CHEF (L√ìGICA CULINARIA) ---

def cocinar_desayuno(bloques):
    plato = []
    estilo = random.choice(["Dulce", "Salado"])
    
    # 1. L√ÅCTEO (Redondeo 10ml/5g)
    if estilo == "Dulce":
        lacteo_nom, lacteo_base, lacteo_unit = random.choice([x for x in DB["Lacteos"] if "Leche" not in x[0]])
    else:
        lacteo_nom, lacteo_base, lacteo_unit = random.choice(DB["Lacteos"])
        
    add_to_cart(f"{lacteo_nom} ({lacteo_unit})", int(lacteo_base))
    plato.append(f"{lacteo_nom} ({int(lacteo_base)}{lacteo_unit})")

    # 2. CEREALES/PAN
    hc_disp = max(0.5, bloques["HC"])
    
    if estilo == "Dulce":
        # Redondeo 10g para avena
        cereal, _ = get_ingrediente_ajustado("Carbo_Desayuno_Dulce", hc_disp, paso_redondeo=10)
        grasa, _ = get_ingrediente_ajustado("Grasas_Dulce", 1, paso_redondeo=5)
        fruta, _ = get_ingrediente_ajustado("Frutas", 1, paso_redondeo=10) # Fruta redondeo suave
        
        plato.append(f"Bowl con {cereal}")
        plato.append(f"Topping: {grasa} y {fruta}")
    else:
        # Redondeo 10g para pan
        cereal, _ = get_ingrediente_ajustado("Carbo_Desayuno_Salado", hc_disp, paso_redondeo=10)
        grasa, _ = get_ingrediente_ajustado("Grasas_Salado", 1, paso_redondeo=5)
        prot, _ = get_ingrediente_ajustado("Proteina_Snack", 1, paso_redondeo=10)
        fruta, _ = get_ingrediente_ajustado("Frutas", 1, paso_redondeo=10)
        
        plato.append(f"Tostadas: {cereal} con {grasa} y {prot}")
        plato.append(f"Postre: {fruta}")

    return " // ".join(plato)

def cocinar_snack(bloques):
    estilo = random.choice(["Dulce", "Salado"])
    plato = []
    
    if estilo == "Dulce":
        l, _ = get_ingrediente_ajustado("Lacteos", 1)
        f, _ = get_ingrediente_ajustado("Frutas", 1)
        plato.append(f"Bowl de {l} con {f}")
        
        if bloques["GRASA"] > 0.5:
            g, _ = get_ingrediente_ajustado("Grasas_Dulce", 1)
            plato.append(f"A√±adir: {g}")
    else:
        p, _ = get_ingrediente_ajustado("Proteina_Snack", 1, paso_redondeo=10)
        if bloques["HC"] >= 0.8:
            pan, _ = get_ingrediente_ajustado("Carbo_Desayuno_Salado", 0.8, paso_redondeo=10)
            plato.append(f"Peque√±o Bocadillo: {pan} con {p}")
        else:
            plato.append(f"Picoteo: {p}")
            
        f, _ = get_ingrediente_ajustado("Frutas", 1)
        plato.append(f"Postre: {f}")

    return " // ".join(plato)

def cocinar_principal(bloques, prot_dia, carbo_dia):
    plato = []
    
    # 1. VEGETAL (Base)
    verdura, _ = get_ingrediente_ajustado("Verduras", 1, paso_redondeo=10)
    plato.append(f"Base: {verdura}")
    
    # 2. PROTE√çNA -> REDONDEO 50g (SOLICITUD DE USUARIO)
    p_nom, p_base, p_unit = prot_dia
    p_total_crudo = p_base * bloques["PROT"]
    # Forzamos pasos de 50g (100, 150, 200, 250)
    p_total = redondear_cantidad(p_total_crudo, 50)
    if p_total < 100: p_total = 100 # M√≠nimo un filete decente
    
    add_to_cart(f"{p_nom} ({p_unit})", p_total)
    plato.append(f"Prote√≠na: {p_nom} ({p_total}{p_unit})")
    
    # 3. GUARNICI√ìN -> REDONDEO 10g (Para no perder precisi√≥n cal√≥rica excesiva)
    c_nom, c_base, c_unit = carbo_dia
    hc_guarnicion = min(bloques["HC"], 2.5) 
    c_total = redondear_cantidad(c_base * hc_guarnicion, 10) # 30, 40, 50g...
    if c_total < 30: c_total = 30 # M√≠nimo guarnici√≥n
    
    add_to_cart(f"{c_nom} ({c_unit})", c_total)
    plato.append(f"Guarnici√≥n: {c_nom} ({c_total}{c_unit})")
    
    # 4. GRASA (Aceite limitado)
    bloques_grasa = max(1, bloques["GRASA"])
    grasa_total_g = 10 * bloques_grasa
    aceite_g = min(15, grasa_total_g)
    
    add_to_cart("Aceite de Oliva Virgen Extra (g)", aceite_g)
    plato.append(f"Aceite ({aceite_g}g)")
    
    # Grasa Acompa√±amiento
    grasa_restante = grasa_total_g - aceite_g
    if grasa_restante >= 10:
        raciones_extra = grasa_restante / 10
        extra_fat, _ = get_ingrediente_ajustado("Grasas_Acompanamiento", raciones_extra, paso_redondeo=10)
        plato.append(f"Acompa√±amiento: {extra_fat}")
    
    # 5. POSTRE
    fruta, _ = get_ingrediente_ajustado("Frutas", 1, paso_redondeo=10)
    plato.append(f"Postre: {fruta}")
    
    return " + ".join(plato)

def generar_menu(kcal, bloques, n_comidas):
    reset_shopping_cart()
    dias = ["LUNES", "MARTES", "MI√âRCOLES", "JUEVES", "VIERNES", "S√ÅBADO", "DOMINGO"]
    
    deck_prot = (DB["Proteina_Plato"] * 2)
    random.shuffle(deck_prot)
    deck_carbo = (DB["Carbo_Guarnicion"] * 2)
    random.shuffle(deck_carbo)
    
    if n_comidas == 3:
        tomas = ["Desayuno", "Almuerzo", "Cena"]
        ratios = {"Desayuno": 0.25, "Almuerzo": 0.40, "Cena": 0.35}
    elif n_comidas == 4:
        tomas = ["Desayuno", "Almuerzo", "Merienda", "Cena"]
        ratios = {"Desayuno": 0.25, "Almuerzo": 0.40, "Merienda": 0.10, "Cena": 0.25}
    else: 
        tomas = ["Desayuno", "Media Ma√±ana", "Almuerzo", "Merienda", "Cena"]
        ratios = {"Desayuno": 0.20, "Media Ma√±ana": 0.10, "Almuerzo": 0.35, "Merienda": 0.10, "Cena": 0.25}

    menu = []

    for i, dia in enumerate(dias):
        prot_dia = deck_prot[i]
        carbo_dia = deck_carbo[i]
        fila = {"D√çA": dia}
        
        for toma in tomas:
            # Factor de correcci√≥n para asegurar m√≠nimos
            b_toma = {k: max(0.5, v * ratios.get(toma)) for k, v in bloques.items()}
            
            if toma == "Desayuno":
                fila[toma] = cocinar_desayuno(b_toma)
            elif toma in ["Media Ma√±ana", "Merienda"]:
                fila[toma] = cocinar_snack(b_toma)
            else: 
                fila[toma] = cocinar_principal(b_toma, prot_dia, carbo_dia)
        
        menu.append(fila)
    return pd.DataFrame(menu)

def imprimir_guia_medidas():
    print("\n" + "="*80)
    print("   üìö ENCICLOPEDIA VISUAL DE MEDIDAS (GU√çA EXPANDIDA)")
    print("="*80)
    print("   ü•Ñ GRASAS Y ACEITES")
    print("     ‚Ä¢ Aceite (1 Cucharada sopera rasa) = 10g")
    print("     ‚Ä¢ Aceite (1 Cucharada sopera llena) = 15g")
    print("     ‚Ä¢ Aceite (1 Cucharadita postre) = 5g")
    print("     ‚Ä¢ Aguacate (Medio, tama√±o mediano) = aprox 100g (carne)")
    print("     ‚Ä¢ Nueces/Almendras (Un pu√±ado cerrado) = 20-30g")
    print("     ‚Ä¢ Crema de Cacahuete (1 Cucharada colmada) = 20-25g")
    print("-" * 80)
    print("   üçö HIDRATOS (PESO EN SECO/CRUDO)")
    print("     ‚Ä¢ Arroz/Pasta (30-40g) = Un pu√±ado peque√±o (guarnici√≥n)")
    print("     ‚Ä¢ Arroz/Pasta (60-80g) = Media taza est√°ndar (plato principal)")
    print("     ‚Ä¢ Arroz/Pasta (100g) = Una taza llena (volumen alto)")
    print("     ‚Ä¢ Patata (1 Unidad tama√±o huevo) = 50g")
    print("     ‚Ä¢ Patata (1 Unidad tama√±o pu√±o) = 150g")
    print("     ‚Ä¢ Copos de Avena (3 Cucharadas soperas) = 30g")
    print("-" * 80)
    print("   ü•© PROTE√çNAS (PESO EN CRUDO)")
    print("     ‚Ä¢ Filete de Pollo/Ternera (Tama√±o baraja de cartas) = 100-120g")
    print("     ‚Ä¢ Filete de Pollo/Ternera (Tama√±o palma mano abierta) = 150-180g")
    print("     ‚Ä¢ Pescado Blanco (Filete est√°ndar) = 150g")
    print("     ‚Ä¢ Lata de At√∫n peque√±a (peso escurrido) = 52g")
    print("     ‚Ä¢ Huevo (Tama√±o L) = aprox 60g")
    print("-" * 80)
    print("   üçé FRUTAS Y VERDURAS")
    print("     ‚Ä¢ Manzana/Pera/Naranja (1 Pieza mediana) = 150g")
    print("     ‚Ä¢ Pl√°tano (1 Unidad mediana sin piel) = 80-90g")
    print("     ‚Ä¢ Fresas (1 Taza llena) = 150g")
    print("     ‚Ä¢ Ensalada (Bolsa est√°ndar supermercado) = 150-200g")
    print("="*80)

# --- 6. EJECUCI√ìN PRINCIPAL ---
if __name__ == "__main__":
    kcal, bloques, n_comidas, g_prot_total = calcular_requerimientos()
    
    print(f"\n‚úÖ PLAN GENERADO CON √âXITO")
    print(f"   üìä Calor√≠as: {kcal} Kcal")
    print(f"   üí™ Prote√≠na: {int(g_prot_total)}g")
    print(f"   üçΩÔ∏è  Estructura: {n_comidas} ingestas diarias")
    
    df = generar_menu(kcal, bloques, n_comidas)
    
    pd.set_option('display.max_colwidth', None)
    for i, row in df.iterrows():
        print(f"\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê {row['D√çA']} ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó")
        orden = ["Desayuno", "Media Ma√±ana", "Almuerzo", "Merienda", "Cena"]
        for comida in orden:
            if comida in row:
                print(f"üëâ {comida.upper()}: {row[comida]}")
        
    print("\n" + "="*50)
    print("üõí LISTA DE LA COMPRA SEMANAL")
    print("   (Todo sumado para ir una sola vez al s√∫per)")
    print("-" * 50)
    for k, v in sorted(SHOPPING_CART.items()):
        # Convertir a kg si es mucho
        if v >= 1000: 
            print(f"[ ] {k}: {v/1000:.2f} kg/L")
        else: 
            print(f"[ ] {k}: {int(v)}")
            
    imprimir_guia_medidas()
